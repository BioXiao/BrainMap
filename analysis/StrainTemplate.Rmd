`r strain` KO vs WT (`r timepoint`)
======================================


- add labels, descriptions
- turn off all caching ! 
- other heatmap labels (csHeatmap)
- overlap figure
- tracks 
- should import litter info


```{r init, echo=FALSE}
# Set knitr opts

path<-paste("figure/",strain,"/",timepoint,"/", sep="")
opts_chunk$set(fig.path=path, echo=FALSE, message=FALSE, warning=FALSE)

### OPTIONAL VAR OVERRIDE (where are my variables!!?)
#dir<-"/n/rinn_data1/seq/lgoff/Projects/BrainMap/data/diffs/linc-Brn1b_vs_WT_Embryonic/"

#strain<-"linc-Brn1b"
alpha<-0.05 
setwd(dir)


### THINGS TO CACHE GO HERE AND NOWHERE ELSE 

```

```{r vars_and_setup,echo=FALSE,results='hide',message=FALSE}
library(cummeRbund)
library(xtable)
library(limma)
library(GSA)
library(gplots)
library(marray)
library(ggplot2)
library(gtable)
library(gridExtra)


reactome_gs <- GSA.read.gmt("/n/rinn_data1/users/agroff/GSEA/c2.cp.reactome.v4.0.symbols.gmt")
biocarta_gs <- GSA.read.gmt("/n/rinn_data1/users/agroff/GSEA/c2.cp.biocarta.v4.0.symbols.gmt")

```

# Intialize
```{r cummeRbund and data setup, echo=FALSE}
setwd(dir)
cuff<-readCufflinks(gtfFile="/n/rinn_data1/seq/lgoff/Projects/BrainMap/data/annotation/mm10_gencode_vM2_with_lncRNAs_and_LacZ.gtf",genome="mm10")
reps<-replicates(cuff)
files<-lapply(reps$file,function(x){strsplit(x, "/")})

#field 9 will be JR number 
files<-as.data.frame(files)
samples<-(t(files[10,]))
rownames(samples)<-NULL

#look up strain, litter, sex, notes in master sheet 

```

# Design Overview

This file shows the wt-v-ko comparison for `r strain`. 

Cuff overview:
```{r}
cuff
```


# QC

## Dispersion

Dispersion plot for genes in cuff:
(Overdispersion can lead to innacurate quants)

```{r dispersion}
dispersionPlot(genes(cuff))
```

## Cross-replicate variability (fpkmSCVplot)
Differences in CV 2 can result in lower numbers of differentially expressed genes due to a higher degree of variability between replicate fpkm estimates.

Genes:
```{r CV genes}
fpkmSCVPlot(genes(cuff))
```


Isoforms: 
```{r cv iso}
fpkmSCVPlot(isoforms(cuff))
```

## Volcano
```{r volcano}
csVolcano(genes(cuff),"wt","ko")
```

### Volcano matrix (replicates)

```{r volcano matrix}
csVolcanoMatrix(genes(cuff),replicates=T)
```

## MvA plot
```{r MvA}
MAplot(genes(cuff),"wt","ko")
```
   
### MvA plot counts
```{r MvA counts}
MAplot(genes(cuff),"wt","ko",useCount=T)
```

## Scatterplot
```{r scatterplot}
csScatterMatrix(genes(cuff))
```

### Scatter matrix (replicates) -- SKIP FOR NOW CAUSING PROBLEMS 

```{r scatterplot matrix}
#csScatterMatrix(genes(cuff),replicates=T)
```


## Distributions

### Boxplots

Boxplot (genes)

```{r boxplot genes}
csBoxplot(genes(cuff))
```

Boxplot (genes, replicates)

```{r boxplot genes replicates}
csBoxplot(genes(cuff),replicates=T)
```

Boxplot (isoforms)

```{r boxplot isoforms}
csBoxplot(isoforms(cuff))
```

Boxplot (isoforms, replicates)

```{r boxplot isoforms replicates}
csBoxplot(isoforms(cuff), replicates=T)
```

### Density

Density (genes)

```{r density}
csDensity(genes(cuff),pseudocount=0.001)
```

Density (genes, replicates)

```{r density w replicates}
csDensity(genes(cuff),pseudocount=0.001,replicates=T)
```


## Clustering

### Replicate Clusters
```{r replicate clusters}
csDendro(genes(cuff),replicates=T)
```

### PCA (genes)
```{r PCA}
PCAplot(genes(cuff),"PC2","PC3", replicates=T)
```

### MDS (genes)
```{r MDS}
MDSplot(genes(cuff),replicates=T)
```


```{r R distance heatmap, eval=FALSE }
### Distance Heat Map (genes)
csDistHeat(genes(cuff), replicates=T)
```


# KO assessment

## Endogenous lncRNA expression

```{r Enodenous lncRNA tables, results='asis'}
myGeneID<-strain
myGene<-getGene(cuff, myGeneID)
#print(xtable(fpkm(myGene)),type="html")
#print(xtable(fpkm(isoforms(myGene))), type="html")
       
#expressionPlot(myGene)
expressionPlot(myGene, replicates=TRUE)
```

Endogenous expression of `r strain` isoforms:

```{r endogenous iso}
#expressionPlot(isoforms(myGene))
expressionPlot(isoforms(myGene), replicates=T)
```

Barplot of gene expression:

```{r endogenous barplot}
#expressionBarplot(myGene)
expressionBarplot(myGene,replicates=T)
```

Barplot of isoform expression:

```{r endogenous iso barplot}
#expressionBarplot(isoforms(myGene))     
expressionBarplot(isoforms(myGene), replicates=T)
```


## LacZ expression

```{r LacZ expression, results='asis'}
myGeneID<-"LacZ"
myGene<-getGene(cuff, myGeneID)

#print(xtable(fpkm(myGene)),type="html")
       
#expressionPlot(myGene)
expressionPlot(myGene, replicates=TRUE)
             
#expressionBarplot(myGene)
expressionBarplot(myGene,replicates=T)
```


## Digital Genotyping (LacZ vs Endogenous lncRNA and Sex)
Expression plot (endogenous linc, lacZ, Y-expressed gene):

```{r Digital Genotyping}
genotypingGeneIDs<-c(strain,"LacZ","Eif2s3y")
genotypingGenes<-getGenes(cuff,genotypingGeneIDs)
expressionBarplot(genotypingGenes,replicates=T)
```

Expression heatmap:
```{r digital geno heatmap}
csHeatmap(genotypingGenes,replicates=T)
```

# Differential Analysis

## Differential Genes 

```{r differential genes}
sig<-getSig(cuff,alpha=alpha)       
sigGenes<-getGenes(cuff,sig)
geneAnnot<-annotation(sigGenes)
```

There are `r length(sig)` significantly differentially expressed genes. They are:

```{r sigdiffGenetable, results="asis"}
print(xtable(as.data.frame(geneAnnot$gene_short_name)),type="html")
```

### Matrix of gene significant differences between conditions

(skip for Brainmap wt-v-ko comparisons)

```{r sigMatrix}
sigMatrix(cuff, level="genes", alpha=alpha)
```

### Significant gene expression differences between conditions

Expression plot (genes):
```{r sigExpression, fig.height=20, fig.width=10}
#RELABEL!
rowlabel<-geneAnnot$gene_short_name
expressionPlot(sigGenes)
csHeatmap(sigGenes, cluster="both",replicates=T)
#Maybe do cluster="col"
#expressionBarplot(sigGenes)
```

Significant genes with expression >50fpkm (any condition):
```{r highly expressed sig}
sigFPKMs<-fpkmMatrix(sigGenes)
high<-sigFPKMs[which(sigFPKMs>50),]
high<-high[complete.cases(high),]
highIDs<-rownames(high)
highGenes<-getGenes(cuff,highIDs)
expressionPlot(highGenes)
```

An individual look at each of the highly expressed significantly differentially regulated genes:
(eval=false for first pass)
```{r plot ALL OF THE SIGNIFICANT GENES, eval=FALSE, fig.height=(20 + (1*(length(highIDs)))), fig.width=(20 + (1*length(highIDs)))}
plots<-lapply(highIDs,function(x){
  myGene<-getGene(cuff,x)
  return(expressionPlot(myGene,replicates=T))
  })
do.call(grid.arrange, plots)
```


### Expression-level/significance relationship

Scatter plot of significant genes only:
```{r expression-sig relationship}
csScatter(sigGenes, "wt", "ko", smooth=T)
```

Volcano plot with significant genes only:
```{r sig volcano}
csVolcano(sigGenes, "wt", "ko")
```


## Differential Splicing

### Differential Isoforms between conditions
Per isoform difference between conditions:
```{r diff.iso}
sigMatrix(cuff, level="isoforms",alpha=alpha)

isoformSigIDs<-getSig(cuff,level="isoforms",alpha=alpha)
isoformSigGenes<-getGenes(cuff,isoformSigIDs)
isoAnnot<-annotation(isoformSigGenes)
```

These isoforms are:
```{r diff iso annotations, results='asis'}
print(xtable(as.data.frame(isoAnnot$gene_short_name)),type="html")
```


```{r isoform heatmap, fig.height=20, fig.width=10}
csHeatmap(isoforms(isoformSigGenes),cluster='both', replicates=T)
```

### Differential Splicing between conditions

(eval false for first pass)

Per condition differences in isoforms (Does gene have diff piechart between conditions?)

```{r diff splicing, eval=FALSE}
splicingSigIDs<-getSig(cuff,level="splicing",alpha=alpha)
splicingSigGenes<-getGenes(cuff,splicingSigIDs)

sigMatrix(cuff, level='splicing', alpha=alpha)

spliceAnnot<-annotation(splicingSigGenes)
```

These genes are:
```{r diff splicing table of genes, results='asis', eval=FALSE}
print(xtable(as.data.frame(spliceAnnot$gene_short_name)), type="html")
```

Splicing heatmap by isoform:
```{r splicing heatmap by isoform, eval=FALSE, fig.height=20, fig.width=10}
#pdf("sigSplicing_heatmap.pdf",width=10,height=20)
csHeatmap(isoforms(splicingSigGenes),cluster='both',method=dist)
#dev.off()
```

Splicing heatmap by gene
```{r splicing heatmap by gene, eval=FALSE}
csHeatmap(splicingSigGenes,cluster='both',method=dist)
```

The following are significantly differentially spliced genes (relative portion of isoform per condition): 

```{r print all the splicing csPie plots, eval=FALSE}
#fig.height=(20 +1*length(splicingSigIDs)), fig.width=(20 +1*length(splicingSigIDs))
#csPiePlots<-lapply(splicingSigIDs,function(x){
#  myGene<-getGene(cuff,x)
#  annot<-annotation(myGene)
#  csPie(myGene) + ggtitle(annot$gene_short_name)
#})
#do.call(grid.arrange,csPiePlots)
```


```{r diff.TSS,eval=FALSE,echo=FALSE, results='hide'}
## Differential Promoter usage (isoforms by tss) <- NOT USING IN BRAINMAP

tssSigIDs<-getSig(cuff,alpha=alpha,level="TSS")
tssSigGenes<-getGenes(cuff,tssSigIDs)

csHeatmap(tssSigGenes,cluster='row',method=dist)

csPiePlots<-lapply(tssSigIDs,function(x){
  myGene<-getGene(cuff,x)
  csPie(myGene)
})
do.call(grid.arrange,csPiePlots)

```
 
```{r diff.promoters,eval=FALSE,echo=FALSE, results='hide'}
## Differential Promoter Usage (By "Promoters") <- NOT USING IN BRAINMAP

promoterSigIDs<-getSig(cuff,alpha=alpha,level="promoters")
promoterSigGenes<-getGenes(cuff,promoterSigIDs)

pdf("sigPromoter_heatmap.pdf",width=10,height=20)
csHeatmap(promoterSigGenes,cluster='row',method=dist)
dev.off()

csPiePlots<-lapply(promoterSigIDs,function(x){
  myGene<-getGene(cuff,x)
  csPie(myGene)
})
do.call(grid.arrange,csPiePlots)


```

```{r diff.CDS,eval=FALSE, echo=FALSE, results='hide'}
## Differential CDS? (unique protein coding isoforms) <-NOT IN BRAINMAP
cdsSigIDs<-getSig(cuff,alpha=alpha,level="CDS")
cdsSigGenes<-getGenes(cuff,cdsSigIDs)

relcdsSigIDs<-getSig(cuff,alpha=alpha,level="relCDS")
relcdsSigGenes<-getGenes(cuff,relcdsSigIDs)


pdf("sigCDS_heatmap.pdf",width=10,height=20)
csHeatmap(cdsSigGenes,cluster='row',method=dist)
dev.off()

pdf("sig_relCDS_heatmap.pdf",width=10,height=20)
csHeatmap(relcdsSigGenes,cluster='row',method=dist)
dev.off()
```

```{r overview.venn,echo=FALSE, eval=FALSE}
## Venn diagram overview of Differential changes


# Make venn diagram of DE genes, DE splicing, DE promoters, DE relCDS (See figure 2)

#install.packages("tiff")
#library(tiff)
#require(VennDiagram)
#venn<-venn.diagram(list(
#    'Genes'=sigGeneIDs,
#    'Splicing'=splicingSigIDs,
#    'Isoforms'=isoformSigIDs,
#    'Promoters'=promoterSigIDs,
#    'TSS'=tssSigIDs),filename=NULL)

#'CDS'=cdsSigIDs,
#'relCDS'=relcdsSigIDs

  
```

# Gene/Pathway Analysis

## GSEA

```{r gsea helper functions}
population<-genes(cuff)
population.diff<-diffData(population)
annotation<-annotation(genes(cuff))
gene_names<-merge(annotation,population.diff)

gene_set_index <- function(genelist, short_names){
  which(short_names %in% genelist)   
}

get_gene_set_p_vals <- function(input, gs, alternative){
  gene_set_indices <- lapply(gs$genesets, function(short_name){
    gene_set_index(input$short_name, short_name)
    })
  pvl<-lapply(gene_set_indices,geneSetTest,input$test_stat, alternative=alternative)
  pvl_mat<-as.data.frame(t(unlist(pvl)))
  colnames(pvl_mat) <- gs$geneset.names
   return(pvl_mat)
}
 
get_gene_set_q_vals <- function(pvl_mat, method="bonferroni"){
	comp_corrected <- matrix(p.adjust(pvl_mat, method=method), nrow=nrow(pvl_mat), ncol=ncol(pvl_mat))
	colnames(comp_corrected) <- colnames(pvl_mat)
	rownames(comp_corrected) <- rownames(pvl_mat)
	return(comp_corrected)
}

colMins<-function(x){
  apply(x,2,min)
}
rowMins<-function(x){
  apply(x,1,min)
}
 
InputCols<-maPalette(low="white",high="red",k=100)
```

```{r gsea}
df.pop<-data.frame("short_name"=toupper(gene_names$gene_short_name),"test_stat"=gene_names$test_stat)
#row.names(df.pop)=population.diff$gene_id
df.pop.unique<-unique(df.pop)
rownames(df.pop.unique)<-NULL
df.pop.unique.ordered<-df.pop.unique[order(df.pop.unique$test_stat),]
Input.df<-df.pop.unique.ordered

reactome_pvl_mat <- get_gene_set_p_vals(Input.df, reactome_gs,alternative="mixed")
reactome_pvl_corrected <- get_gene_set_q_vals(reactome_pvl_mat)
reactome_pvl_corrected<-rbind(reactome_pvl_corrected,reactome_pvl_corrected)


biocarta_pvl_mat <- get_gene_set_p_vals(Input.df, biocarta_gs, alternative="mixed")
biocarta_pvl_corrected <- get_gene_set_q_vals(biocarta_pvl_mat)
biocarta_pvl_corrected<-rbind(biocarta_pvl_corrected,biocarta_pvl_corrected)
```

```{r print GSEA biocarta, fig.height=20, fig.width=10}
#two options, print as pdf, and adjust size in separate code block
#make minimum height and then increment scaled by number of rows to return 


#setwd('/n/rinn_data1/users/agroff/GITHUB/BrainMap/analysis')

#print to file 
#pdf("components_GSEA_biocarta.pdf",width=10,height=30)

#take top 50
x<-(-log10(t(biocarta_pvl_corrected[,which(colMins(biocarta_pvl_corrected) < 0.001)])))

x_ordered<-x[order(x[,1], decreasing=TRUE),]
x_ordered_subset<-x_ordered[1:50,]
noinfinities_x<-x_ordered_subset[which(x_ordered_subset !="Inf")]
x_max<-max(noinfinities_x)+100
x_ordered_subset[x_ordered_subset=="Inf"]<-x_max


heatmap.2(x_ordered_subset, trace="none", margins=c(5,20), col=InputCols,dendrogram="row",lhei =c(0.1,0.9), labCol=c(""))

#dev.off()

#print to report 
#heatmap.2(x_ordered_subset, trace="none", margins=c(5,30), col=InputCols,dendrogram="row",lhei =c(0.1,0.9), labCol=c(""))
```

```{r print GSEA reactome, fig.width=10, fig.height=20}

#print to file
#pdf("components_GSEA_reactome.pdf",width=10,height=30)

#take top 50 because this is ridiculous
#x<-(-log10(t(reactome_pvl_corrected[,which(colMins(reactome_pvl_corrected) < 0.0000000000000000000000001)])))

x<-(-log10(t(reactome_pvl_corrected[,which(colMins(reactome_pvl_corrected) < 0.0001)])))
x_ordered<-x[order(x[,1], decreasing=TRUE),]
x_ordered_subset<-x_ordered[1:50,]
noinfinities_x<-x_ordered_subset[which(x_ordered_subset !="Inf")]
x_max<-max(noinfinities_x)+100
x_ordered_subset[x_ordered_subset=="Inf"]<-x_max


heatmap.2(x_ordered_subset, trace="none", margins=c(5,20),col=InputCols,dendrogram="both",lhei = c(0.1,0.90), labCol=c(""))
#cexRow = (0.2 + .5/log10(dim(x)[1]))
#dev.off()

#print to report 
#heatmap.2(x_ordered_subset, trace="none", margins=c(5,30),col=InputCols,dendrogram="both",lhei = c(0.1,0.90), labCol=c(""))

```

## GO enrichment 
Cluster profiler used to call enichments of significantly differentially regulated genes that map to Entrez IDs. 

```{r GO setup, echo=FALSE}
#source("http://bioconductor.org/biocLite.R")
#biocLite("ReactomePA")

library(ReactomePA)
library(DOSE)


sigGeneIDs<-getSig(cuff, alpha=alpha)
sigGenes<-getGenes(cuff,sigGeneIDs)
geneAnnot<-annotation(sigGenes)
geneNames<-geneAnnot$gene_short_name
sigDiff<-diffData(sigGenes)
sigDiff$foldChange<-sigDiff$value_1/sigDiff$value_2


# Top genes by test stat
#diff<-diffData(genes(cuff))
#diff<-diff[order(abs(diff$test_stat),decreasing=TRUE),]
#top_genes<-diff[which(diff$p_value<0.1),]
#top_genes_annot<-merge(top_genes,population)
#geneNames<-top_genes_annot$gene_short_name

```

```{r GO analysis setup and functions}
library(clusterProfiler)
require(biomaRt)
#source("http://bioconductor.org/biocLite.R")
#biocLite("clusterProfiler")
#biocLite("org.Mm.eg.db")
#http://www.bioconductor.org/packages/release/bioc/vignettes/biomaRt/inst/doc/biomaRt.pdf

ensembl <- useMart("ENSEMBL_MART_ENSEMBL","mmusculus_gene_ensembl", 
host="www.ensembl.org")

#Get entrezIDs
getEntrezIDs<-function (geneNames)
{
    tmp <- getBM(attributes = c("entrezgene"), filters = "mgi_symbol", values = geneNames, mart = ensembl)
    tmp
}
sigEntrez<-getEntrezIDs(geneNames)
sigEZ<-strsplit(as.character(sigEntrez), ", ")
sigEZ<-unlist(sigEZ)
require(org.Mm.eg.db) #mapping of entrez IDs to genbank

goBP<-enrichGO(gene=sigEZ, organism="mouse",ont="BP",pvalueCutoff=0.01,readable=T)

goMF<-enrichGO(gene=sigEZ, organism="mouse",ont="MF",pvalueCutoff=0.01,readable=T)

goCC<-enrichGO(gene=sigEZ, organism="mouse",ont="CC",pvalueCutoff=0.01,readable=T)

kegg<-enrichKEGG(gene=sigEZ, organism="mouse",pvalueCutoff=1, readable=T)

pathway<-enrichPathway(gene=sigEZ,organism="mouse",pvalueCutoff=0.01, readable=T)

```

```{r GO figures,  fig.height=5, fig.width=8}
plot(goBP,showCategory=10) + theme(axis.text.x=element_text(angle=-90,hjust=0)) + ggtitle("Enriched BP")

plot(goMF,showCategory=10) + theme(axis.text.x=element_text(angle=-90,hjust=0)) + ggtitle("Enriched MF")

plot(goCC,showCategory=10) + theme(axis.text.x=element_text(angle=-90,hjust=0)) + ggtitle("Enriched CC")

plot(kegg, showCategory=10) + ggtitle("Kegg Pathways")

plot(pathway,showCategory=10) + ggtitle("Reactome pathway enrichment")
detach("package:biomaRt")
```

# Cis vs Trans (locally)
``` {r cis_v_trans}
window<-1000000











```


# Notes

## Samples used are:
```{r results='asis', echo=FALSE}
print(xtable(samples),type="html")
```

## Replicates
```{r replicates, results='asis'}
print(xtable(replicates(cuff)),type="html")
```

## Session Info
```{r session}
sessionInfo()
```

## Run Info
```{r runInfo}
runInfo(cuff)
```
